---
# ==============================================================================
# PLAY 1: PREPARE HARDWARE & INSTALL SOFTWARE
# ==============================================================================
- name: Play 1 - Prepare Infrastructure (All Nodes)
  hosts: all
  become: true
  vars:
    socket_path: "/var/run/mysqld/mysqld.sock"
    galera_packages:
      - mariadb-server
      - galera-4
      - python3-pymysql

  tasks:
    - name: Ensure MySQL Group exists
      group:
        name: mysql
        state: present
        system: yes

    - name: Ensure MySQL User exists
      user:
        name: mysql
        group: mysql
        system: yes
        shell: /bin/false
        create_home: no

    - name: Identify Root Disk Name
      set_fact:
        root_disk_name: "{{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='device') | list | first | regex_replace('/dev/', '') | regex_replace('[0-9]+$', '') }}"

    - name: Find Candidate Data Disks
      set_fact:
        target_disks: "{{ target_disks | default([]) + ['/dev/' + item.key] }}"
      when:
        - item.key != root_disk_name
        - not item.key.startswith(('loop', 'ram', 'sr', 'dm'))
        - item.value.size | human_to_bytes > 5368709120
      loop: "{{ ansible_devices | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    # --- SAFETY WIPE LOGIC ---
    - name: FORCE WIPE (Clean Slate)
      block:
        - name: Stop MariaDB (If running)
          service:
            name: mariadb
            state: stopped
          ignore_errors: true

        - name: Unmount all MySQL paths
          mount:
            path: "{{ item }}"
            state: unmounted
          loop: ['/var/lib/mysql', '/var/log/mysql', '/var/tmp/mysql', '/var/lib/galera_cache']
          ignore_errors: true

        - name: Destroy LVM Groups
          community.general.lvg:
            vg: mysql_vg
            state: absent
            force: yes
          ignore_errors: true

        - name: Wipe Raw Disk Signatures
          command: "wipefs -a {{ item }}"
          loop: "{{ target_disks }}"
      when: 
        - force_wipe | default(false) | bool
        - target_disks is defined

    # --- DISK SETUP ---
    - name: Configure Disk and Mounts
      import_tasks: tasks/disk_setup.yml
      when: target_disks is defined

    # --- INSTALLATION ---
    - name: Install MariaDB Packages
      apt:
        name: "{{ galera_packages }}"
        state: present
        update_cache: yes
 

    - name: 3. Disable AppArmor
      shell: "ln -s /etc/apparmor.d/usr.sbin.mariadbd /etc/apparmor.d/disable/ || true; apparmor_parser -R /etc/apparmor.d/usr.sbin.mariadbd || true"
      ignore_errors: true

 

    # --- CONFIGURATION ---
    - name: Stop MariaDB for Configuration
      service:
        name: mariadb
        state: stopped

    - name: Deploy Cluster Configs
      template:
        src: "templates/{{ item.src }}"
        dest: "/etc/mysql/mariadb.conf.d/{{ item.dest }}"
        mode: '0644'
      loop:
        - { src: 'mariadb.cnf.j2', dest: '60-mariadb.cnf' }
        - { src: 'galera.cnf.j2', dest: '99-galera.cnf' }
      when: inventory_hostname in groups['mariadb_nodes']

    - name: Deploy Async Slave Config
      copy:
        dest: /etc/mysql/mariadb.conf.d/50-async-server.cnf
        content: |
          [mysqld]
          server_id={{ 100 + (ansible_default_ipv4.address.split('.')[-1] | int) }}
          log_bin=mysql-bin
          binlog_format=row
          wsrep_on=OFF
          bind-address=0.0.0.0
          datadir=/var/lib/mysql
      when: inventory_hostname in groups['async_node']


# ==============================================================================
# PLAY 2: BOOTSTRAP CLUSTER (Leader Only)
# ==============================================================================
- name: Play 2 - Bootstrap Cluster
  hosts: "{{ groups['mariadb_nodes'][0] }}"
  become: true

  tasks:
    - name: Bootstrap Cluster
      command: galera_new_cluster

    - name: Wait for Leader Ready
      wait_for:
        port: 3306
        timeout: 60


# ==============================================================================
# PLAY 3: JOIN FOLLOWERS
# ==============================================================================
- name: Play 3 - Join Cluster
  hosts: "{{ groups['mariadb_nodes'][1:] }}"
  become: true
  serial: 1

  tasks:
    - name: Start MariaDB (Join Cluster)
      service:
        name: mariadb
        state: started

    - name: Wait for Node to Sync
      community.mysql.mysql_query:
        query: "SHOW STATUS LIKE 'wsrep_local_state_comment'"
        login_unix_socket: /var/run/mysqld/mysqld.sock
      register: sync_status
      until: sync_status.query_result[0][0].Value == 'Synced'
      retries: 30
      delay: 10


# ==============================================================================
# PLAY 4: SECURITY & REPLICATION SETUP
# ==============================================================================
- name: Play 4 - Security & Master Setup
  hosts: "{{ groups['mariadb_nodes'][0] }}"
  become: true
  
  tasks:
    - name: Set Root Password
      community.mysql.mysql_user:
        name: root
        host: localhost
        password: "{{ mysql_root_password }}"
        priv: "*.*:ALL,GRANT"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Remove Anonymous Users
      community.mysql.mysql_user:
        name: ""
        state: absent
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Create Replication User
      community.mysql.mysql_user:
        name: repl_user
        password: "{{ mysql_root_password }}"
        host: "%"
        priv: "*.*:REPLICATION SLAVE"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Get Master Coordinates
      community.mysql.mysql_replication:
        mode: getprimary
        login_unix_socket: /var/run/mysqld/mysqld.sock
      register: master_status


# ==============================================================================
# PLAY 5: CONFIGURE ASYNC SLAVE
# ==============================================================================
- name: Play 5 - Configure Async Slave
  hosts: "{{ groups['async_node'] }}"
  become: true

  tasks:
    - name: Start MariaDB
      service:
        name: mariadb
        state: started

    - name: Configure Replication Source
      community.mysql.mysql_replication:
        mode: changeprimary
        primary_host: "{{ groups['mariadb_nodes'][0] }}"
        primary_user: repl_user
        primary_password: "{{ mysql_root_password }}"
        primary_log_file: "{{ hostvars[groups['mariadb_nodes'][0]]['master_status']['File'] }}"
        primary_log_pos: "{{ hostvars[groups['mariadb_nodes'][0]]['master_status']['Position'] }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Start Replication
      community.mysql.mysql_replication:
        mode: startreplica
        login_unix_socket: /var/run/mysqld/mysqld.sock


# ==============================================================================
# PLAY 6: VERIFY DEPLOYMENT
# ==============================================================================
- name: Play 6 - Verify Cluster Health
  hosts: "{{ groups['mariadb_nodes'][0] }}"
  become: true

  tasks:
    - name: Check Cluster Size
      community.mysql.mysql_query:
        query: "SHOW STATUS LIKE 'wsrep_cluster_size'"
        login_unix_socket: /var/run/mysqld/mysqld.sock
      register: final_size

    - name: Display Result
      debug:
        msg: "âœ“ Cluster deployed with {{ final_size.query_result[0][0].Value }}/{{ groups['mariadb_nodes'] | length }} nodes"
